<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
 <head><title>Request data from the internet</title><meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description"
   content="Use the XHR capabilities to get information from the web"/>
  <link rel="stylesheet" href="/styles.css"/>
 </head>
 <body>
             
  <div class="nav"><h1 class="title"><a href="/">jsoo-mithril</a></h1>
   <ul>
    <li><a href="/tutorial">Tutorial</a>
     <ul><li><a href="/tutorial/hello-world">Hello World</a></li>
      <li>
       <a href="/tutorial/counter-closure-component">
        Counter closure component
       </a>
      </li>
      <li>
       <a href="/tutorial/request-data-from-the-internet">
        Request data from the internet
       </a>
      </li><li><a href="/tutorial/todo-stack">Todo Stack</a></li>
      <li><a href="/tutorial/routing">Routing</a></li>
      <li><a href="/tutorial/markdown-editor">Markdown Editor</a></li>
     </ul>
    </li>
   </ul>
  </div>
  <div class="content">
   <div class="meta"><h2>Request data from the internet</h2>
    <p> By Patrick Ferris on 2021-01-20 18:11:21 +00:00</p>
   </div>
   <p>The data we want to display on our website can't always be known statically. Take, for example, a weather app. This information is constantly changing and needs refreshing (perhaps by a user clicking on a button).</p>
<p><a href="https://en.wikipedia.org/wiki/XMLHttpRequest#:~:text=XMLHttpRequest%20(XHR)%20is%20an%20API,by%20the%20browser's%20JavaScript%20environment.">XHR</a> or XMLHttpRequest is an API provided by the browser's Javascript environment exposing methods for making requests between websites to servers. Mithril has built-in functionality for making requests and re-rendering components as that data changes.</p>
<p><a href="https://rem-rest-api.herokuapp.com/">REM</a> is a service we can use to make requests to show how it works. We will query the <code>/api/users</code> end-point to get the small set of users. First we will open some libraries and describe our <code>User</code>.</p>
<h2 id="rem-user-example">REM User Example</h2>
<p><a href="./example">Full example is running here</a>.</p>
<!-- $MDX file=./example/index.ml,part=0 -->
<pre><code><span class="ocaml-keyword">open</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Mithril</span><span class="ocaml-source">
</span><span class="ocaml-keyword">open</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Fut</span><span class="ocaml-keyword">.</span><span class="ocaml-constant-language">Result_syntax</span><span class="ocaml-source">
</span><span class="ocaml-source">
</span><span class="ocaml-keyword">module</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">User</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-keyword">struct</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-keyword">type</span><span class="ocaml-source"> </span><span class="ocaml-source">t</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Jv</span><span class="ocaml-keyword">.</span><span class="ocaml-source">t</span><span class="ocaml-source">
</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-source">let </span><span class="ocaml-entity-name">first_name</span><span class="ocaml-source"> </span><span class="ocaml-source">t</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Jv</span><span class="ocaml-keyword">.</span><span class="ocaml-source">get</span><span class="ocaml-source"> </span><span class="ocaml-source">t</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">firstName</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">|&gt;</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Jv</span><span class="ocaml-keyword">.</span><span class="ocaml-source">to_string</span><span class="ocaml-source">
</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-source">let </span><span class="ocaml-entity-name">last_name</span><span class="ocaml-source"> </span><span class="ocaml-source">t</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Jv</span><span class="ocaml-keyword">.</span><span class="ocaml-source">get</span><span class="ocaml-source"> </span><span class="ocaml-source">t</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">lastName</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">|&gt;</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Jv</span><span class="ocaml-keyword">.</span><span class="ocaml-source">to_string</span><span class="ocaml-source">
</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-source">let </span><span class="ocaml-entity-name">id</span><span class="ocaml-source"> </span><span class="ocaml-source">t</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Jv</span><span class="ocaml-keyword">.</span><span class="ocaml-source">get</span><span class="ocaml-source"> </span><span class="ocaml-source">t</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">id</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">|&gt;</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Jv</span><span class="ocaml-keyword">.</span><span class="ocaml-source">to_int</span><span class="ocaml-source">
</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-source">let </span><span class="ocaml-entity-name">of_list</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">List</span><span class="ocaml-keyword">.</span><span class="ocaml-source">map</span><span class="ocaml-source"> </span><span class="ocaml-source">(</span><span class="ocaml-keyword">fun</span><span class="ocaml-source"> </span><span class="ocaml-source">t</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">-&gt;</span><span class="ocaml-source"> </span><span class="ocaml-source">first_name</span><span class="ocaml-source"> </span><span class="ocaml-source">t</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">^</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">^</span><span class="ocaml-source"> </span><span class="ocaml-source">last_name</span><span class="ocaml-source"> </span><span class="ocaml-source">t</span><span class="ocaml-source">)</span><span class="ocaml-source">
</span><span class="ocaml-keyword">end</span><span class="ocaml-source">
</span></code></pre><p><code>Fut.Result_syntax</code> is part of <a href="https://erratique.ch/software/brr">Brr</a>. It provides a <em>monadic</em> syntax for working with Javascript promises, we'll be using that later.</p>
<p>The underlying data-type for our user (<code>User.t</code>) is just a Javascript value and we provide (not very safe but more concise) accessors for the various bits of information.</p>
<p>Next we define some state.</p>
<!-- $MDX file=./example/index.ml,part=1 -->
<pre><code><span class="ocaml-keyword">let</span><span class="ocaml-source"> </span><span class="ocaml-source">users</span><span class="ocaml-keyword">,</span><span class="ocaml-source"> </span><span class="ocaml-source">add_user</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-keyword">let</span><span class="ocaml-source"> </span><span class="ocaml-source">(</span><span class="ocaml-source">lst</span><span class="ocaml-source"> </span><span class="ocaml-keyword">:</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">User</span><span class="ocaml-keyword">.</span><span class="ocaml-source">t</span><span class="ocaml-source"> </span><span class="ocaml-source">list</span><span class="ocaml-source"> </span><span class="ocaml-source">ref</span><span class="ocaml-source">)</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-source">ref</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">[]</span><span class="ocaml-source"> </span><span class="ocaml-keyword">in</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-source">let </span><span class="ocaml-entity-name">add_user</span><span class="ocaml-source"> </span><span class="ocaml-source">t</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-source">lst</span><span class="ocaml-source"> </span><span class="ocaml-keyword">:</span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">List</span><span class="ocaml-keyword">.</span><span class="ocaml-source">sort</span><span class="ocaml-source"> </span><span class="ocaml-source">(</span><span class="ocaml-keyword">fun</span><span class="ocaml-source"> </span><span class="ocaml-source">a</span><span class="ocaml-source"> </span><span class="ocaml-source">b</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">-&gt;</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Int</span><span class="ocaml-keyword">.</span><span class="ocaml-source">compare</span><span class="ocaml-source"> </span><span class="ocaml-source">(</span><span class="ocaml-constant-language">User</span><span class="ocaml-keyword">.</span><span class="ocaml-source">id</span><span class="ocaml-source"> </span><span class="ocaml-source">a</span><span class="ocaml-source">)</span><span class="ocaml-source"> </span><span class="ocaml-source">(</span><span class="ocaml-constant-language">User</span><span class="ocaml-keyword">.</span><span class="ocaml-source">id</span><span class="ocaml-source"> </span><span class="ocaml-source">b</span><span class="ocaml-source">)</span><span class="ocaml-source">)</span><span class="ocaml-source"> </span><span class="ocaml-source">(</span><span class="ocaml-source">t</span><span class="ocaml-source"> </span><span class="ocaml-keyword">:</span><span class="ocaml-keyword">:</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">!</span><span class="ocaml-source">lst</span><span class="ocaml-source">)</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-keyword">in</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-source">(</span><span class="ocaml-source">lst</span><span class="ocaml-keyword">,</span><span class="ocaml-source"> </span><span class="ocaml-source">add_user</span><span class="ocaml-source">)</span><span class="ocaml-source">
</span></code></pre><p>This is initialised once (when the page loads). And provides a reference to a list of users and a function, <code>add_user</code>, for pushing a new user to the list. The list is automatically resorted by <code>id</code> (again there are more efficient implementations but we ar striving for simplicity here).</p>
<p>Now we define the main <code>user_xhr</code> component.</p>
<!-- $MDX file=./example/index.ml,part=2 -->
<pre><code><span class="ocaml-source">let </span><span class="ocaml-entity-name">user_xhr</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-source">let </span><span class="ocaml-entity-name">fetch_users</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">()</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-source">let </span><span class="ocaml-entity-name">url</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">http://rem-rest-api.herokuapp.com/api/users</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> </span><span class="ocaml-keyword">in</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-source">let </span><span class="ocaml-entity-name">opts</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">M</span><span class="ocaml-keyword">.</span><span class="ocaml-constant-language">Request</span><span class="ocaml-keyword">.</span><span class="ocaml-source">opts</span><span class="ocaml-source"> ~</span><span class="ocaml-source">method_</span><span class="ocaml-keyword">:</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">GET</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> ~</span><span class="ocaml-source">with_credentials</span><span class="ocaml-keyword">:</span><span class="ocaml-constant-language">true</span><span class="ocaml-source"> </span><span class="ocaml-source">url</span><span class="ocaml-source"> </span><span class="ocaml-keyword">in</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-keyword">let</span><span class="ocaml-keyword">+ </span><span class="ocaml-entity-name">data</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">M</span><span class="ocaml-keyword">.</span><span class="ocaml-constant-language">Request</span><span class="ocaml-keyword">.</span><span class="ocaml-source">make</span><span class="ocaml-source"> </span><span class="ocaml-source">opts</span><span class="ocaml-source"> </span><span class="ocaml-keyword">in</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-constant-language">Jv</span><span class="ocaml-keyword">.</span><span class="ocaml-source">get</span><span class="ocaml-source"> </span><span class="ocaml-source">data</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">data</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">|&gt;</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Jv</span><span class="ocaml-keyword">.</span><span class="ocaml-source">to_list</span><span class="ocaml-source"> </span><span class="ocaml-source">(</span><span class="ocaml-keyword">fun</span><span class="ocaml-source"> </span><span class="ocaml-source">x</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">-&gt;</span><span class="ocaml-source"> </span><span class="ocaml-source">x</span><span class="ocaml-source">)</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">|&gt;</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">List</span><span class="ocaml-keyword">.</span><span class="ocaml-source">iter</span><span class="ocaml-source"> </span><span class="ocaml-source">add_user</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-keyword">in</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-source">let </span><span class="ocaml-entity-name">attr</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-source">[|</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Attr</span><span class="ocaml-keyword">.</span><span class="ocaml-source">attr</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">onclick</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> </span><span class="ocaml-source">(</span><span class="ocaml-constant-language">Jv</span><span class="ocaml-keyword">.</span><span class="ocaml-source">repr</span><span class="ocaml-source"> </span><span class="ocaml-source">fetch_users</span><span class="ocaml-source">)</span><span class="ocaml-source"> </span><span class="ocaml-source">|]</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">|&gt;</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Attr</span><span class="ocaml-keyword">.</span><span class="ocaml-source">v</span><span class="ocaml-source"> </span><span class="ocaml-keyword">in</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-source">let </span><span class="ocaml-entity-name">view</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">_</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-constant-language">M</span><span class="ocaml-keyword">.</span><span class="ocaml-source">v</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">div</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source">
</span><span class="ocaml-source">      ~</span><span class="ocaml-source">children</span><span class="ocaml-keyword">:</span><span class="ocaml-source">
</span><span class="ocaml-source">        </span><span class="ocaml-source">(</span><span class="ocaml-constant-language">`Vnodes</span><span class="ocaml-source">
</span><span class="ocaml-source">          </span><span class="ocaml-source">[</span><span class="ocaml-source">
</span><span class="ocaml-source">            </span><span class="ocaml-constant-language">M</span><span class="ocaml-keyword">.</span><span class="ocaml-source">(</span><span class="ocaml-source">v</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">button</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> ~</span><span class="ocaml-source">attr</span><span class="ocaml-source"> ~</span><span class="ocaml-source">children</span><span class="ocaml-keyword">:</span><span class="ocaml-source">(</span><span class="ocaml-constant-language">`String</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">Get Users</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source">)</span><span class="ocaml-source">)</span><span class="ocaml-keyword">;</span><span class="ocaml-source">
</span><span class="ocaml-source">            </span><span class="ocaml-constant-language">M</span><span class="ocaml-keyword">.</span><span class="ocaml-source">(</span><span class="ocaml-source">
</span><span class="ocaml-source">              </span><span class="ocaml-source">v</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">p</span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source">
</span><span class="ocaml-source">                ~</span><span class="ocaml-source">children</span><span class="ocaml-keyword">:</span><span class="ocaml-source">(</span><span class="ocaml-constant-language">`String</span><span class="ocaml-source"> </span><span class="ocaml-source">(</span><span class="ocaml-constant-language">String</span><span class="ocaml-keyword">.</span><span class="ocaml-source">concat</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-string-quoted">, </span><span class="ocaml-string-quoted">&quot;</span><span class="ocaml-source"> </span><span class="ocaml-source">(</span><span class="ocaml-constant-language">User</span><span class="ocaml-keyword">.</span><span class="ocaml-source">of_list</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">!</span><span class="ocaml-source">users</span><span class="ocaml-source">)</span><span class="ocaml-source">)</span><span class="ocaml-source">)</span><span class="ocaml-source">)</span><span class="ocaml-keyword">;</span><span class="ocaml-source">
</span><span class="ocaml-source">          </span><span class="ocaml-source">]</span><span class="ocaml-source">)</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-keyword">in</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-constant-language">Component</span><span class="ocaml-keyword">.</span><span class="ocaml-source">v</span><span class="ocaml-source"> </span><span class="ocaml-source">view</span><span class="ocaml-source">
</span></code></pre><p>It has a <code>button</code> for fetching users and a <code>paragraph</code> for displaying them. This is code is meant to just show you how it works not be useful. Clicking the button multiple times will just keep adding to the list of users.</p>
<p>The most interesting part of this is the <code>fetch_users</code> function. It uses the <code>M.Request</code> module for preparing and sending the <code>GET</code> request to the end-point.</p>
<p><code>M.Request.opts</code> is used to form the options for the function with only the <code>url</code> (a string) being required. <code>M.Request.make</code> makes the request and returns a promise which resolves to an error or a <code>Jv.t</code>. The <code>let+ data = M.Request.make opts</code> syntax unwraps the promise and the error binding <code>data</code> to the <code>Jv.t</code>.</p>
<p>No error handling has been implemented here -- that's a good reader exercise ;)</p>
<p>Finally we mount the component to the body.</p>
<!-- $MDX file=./example/index.ml,part=3 -->
<pre><code><span class="ocaml-keyword">let</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">()</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-source">let </span><span class="ocaml-entity-name">body</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">=</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">Brr</span><span class="ocaml-keyword">.</span><span class="ocaml-source">(</span><span class="ocaml-constant-language">Document</span><span class="ocaml-keyword">.</span><span class="ocaml-source">body</span><span class="ocaml-source"> </span><span class="ocaml-constant-language">G</span><span class="ocaml-keyword">.</span><span class="ocaml-source">document</span><span class="ocaml-source">)</span><span class="ocaml-source"> </span><span class="ocaml-keyword">in</span><span class="ocaml-source">
</span><span class="ocaml-source">  </span><span class="ocaml-constant-language">M</span><span class="ocaml-keyword">.</span><span class="ocaml-source">(</span><span class="ocaml-source">mount</span><span class="ocaml-source"> </span><span class="ocaml-source">body</span><span class="ocaml-source"> </span><span class="ocaml-source">user_xhr</span><span class="ocaml-source">)</span><span class="ocaml-source">
</span></code></pre>
   <ol></ol>
  </div><script src='/index.js'></script>
                                             
                                             
                                           
 </body>
</html>